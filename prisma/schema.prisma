generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum FocusArea {
  EDUCATION
  CAREER
  FINANCE
  HEALTH_SPORTS
  RELATIONSHIPS
}

enum MotivationCard {
  FAMILY_LOVED_ONES
  FREEDOM_INDEPENDENCE
  PROVE_YOURSELF
  COMFORT_LUXURY
  CURIOSITY_GROWTH
  INNER_PEACE_BALANCE
}

enum ZodiacSign {
  ARIES
  TAURUS
  GEMINI
  CANCER
  LEO
  VIRGO
  LIBRA
  SCORPIO
  SAGITTARIUS
  CAPRICORN
  AQUARIUS
  PISCES
}

enum UserRole {
  USER
  ADMIN
}

enum MaritalStatus {
  SINGLE
  IN_RELATIONSHIP
  MARRIED
  SEPARATED_DIVORCED
  PREFER_NOT_TO_SAY
}

enum InterestCategory {
  PERSONAL_DEVELOPMENT
  RELATIONSHIPS_PSYCHOLOGY
  BUSINESS_ENTREPRENEURSHIP
  FITNESS_HEALTH
  FOOD_LIFESTYLE
  FINANCE_INVESTING
  FASHION_STYLE
  TECHNOLOGY
  MINIMALISM
  MOTIVATION_HABITS
}

enum PrimaryGoal {
  SELF_IMPROVEMENT
  MORE_MONEY
  BETTER_RELATIONSHIP
  BETTER_APPEARANCE
  HEALTHIER
  CAREER_ADVANCEMENT
  QUIT_BAD_HABITS
}

enum GoalTimeframe {
  ONE_MONTH
  THREE_MONTHS
  SIX_MONTHS
  ONE_YEAR
}

enum StressLevel {
  LOW
  MEDIUM
  HIGH
}

enum ContentTypePreference {
  VIDEO
  ARTICLE
  QUIZ
  PODCAST
  SHORT_NOTES
}

enum MotivationType {
  MONEY
  STATUS_APPROVAL
  SECURITY_COMFORT
  LOVE_ACCEPTANCE
  FREEDOM
  SUCCESS_POWER
}

enum BiggestStruggle {
  FOCUS
  RELATIONSHIPS
  MONEY_MANAGEMENT
  SELF_CONFIDENCE
  HEALTH_DISCIPLINE
  WORK_LIFE
  MOTIVATION
}

enum EnergyDipTime {
  AFTERNOON_14_16 // √ñƒüleden sonra (14:00-16:00)
  EVENING_18      // Ak≈üam√ºst√º yorgunluƒüu (18:00)
  MORNING_07      // Sabah uyanmak zor (07:00)
  NIGHT_23        // Gece ku≈üuyum ama √ß√∂k√ºyorum (23:00)
}

enum ComfortZone {
  COFFEE_SMELL   // Kahve kokusu ‚òï
  PLAY_WITH_PET  // Evcil hayvanƒ±mla oynamak üêæ
  LISTEN_MUSIC   // M√ºzik dinlemek üéß
  CHOCOLATE      // √áikolata ka√ßamaƒüƒ± üç´
  WALK           // Y√ºr√ºy√º≈ü yapmak üëü
}

enum NegativeSelfTalk {
  INADEQUATE         // "Yetersizim / Yapamayacaƒüƒ±m."
  TOO_LATE           // "√áok ge√ß kaldƒ±m."
  MUST_BE_PERFECT    // "M√ºkemmel olmalƒ±."
  WHAT_WILL_THEY_SAY // "ƒ∞nsanlar ne der?"
}

enum WorkContext {
  OFFICE_PLAZA   // Ofis/Plaza (Kurumsal)
  HOME_OFFICE    // Ev/Home Office (Yalnƒ±z)
  CAFE_OUTSIDE   // Kafe/Dƒ±≈üarƒ±sƒ± (G√ºr√ºlt√ºl√º)
  SCHOOL_LIBRARY // Okul/K√ºt√ºphane (Akademik)
}

enum ToneOfVoice {
  SERGEANT // üéñÔ∏è √áavu≈ü Modu: Sert
  ZEN      // üåø Zen Modu: Yumu≈üak
  LOGIC    // üß† Mantƒ±k Modu: Analitik
}

enum BigDayType {
  EXAM
  PRESENTATION
  WEDDING
  PROJECT_DEADLINE
  VACATION
  OTHER
}

enum ChildrenAgeRange {
  BABY_0_2
  CHILD_3_12
  TEEN_13_17
  ADULT_18_PLUS
  MIXED
}

enum NotificationStatus {
  PENDING
  SCHEDULED
  SENT
  FAILED
}

enum SurveyStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model User {
  id             Int        @id @default(autoincrement())
  deviceId       String?    @unique
  createdAt      DateTime   @default(now())
  lastFeedbackAt DateTime?
  feedbacks      Feedback[]

  // New relations for inbox + notification feedback
  userNotifications     UserNotification[]
  notificationFeedbacks NotificationFeedback[]
  surveyResponses       SurveyResponse[]

  role     UserRole @default(USER)
  isActive Boolean  @default(true)

  // Onboarding (Ekran 1-5)
  birthDate  DateTime? // birthYear yerine deƒüil, yanƒ±nda (istersen sonra birthYear'i de buradan t√ºretirsin)
  zodiacSign ZodiacSign?

  hometown String? // memleket (opsiyonel)

  focusArea   FocusArea?
  focusDetail String? // FINANCE ise: "CRYPTO/BORSA/..." gibi veya HEALTH_SPORTS: "YOGA/FITNESS/..."

  motivationCard MotivationCard?

  timezone String? // opsiyonel: Europe/Istanbul gibi, konum/saat i√ßin i≈üe yarar

  email                      String?   @unique
  passwordHash               String?
  isEmailVerified            Boolean   @default(false)
  emailVerificationToken     String?
  emailVerificationExpiresAt DateTime?

  passwordResetToken     String?
  passwordResetExpiresAt DateTime?

  fullName       String?
  birthYear      Int?
  gender         Gender?
  city           String?
  occupation     String?
  educationLevel String?
  maritalStatus  MaritalStatus?

  interests InterestCategory[]

  primaryGoal   PrimaryGoal?
  goalTimeframe GoalTimeframe?

  dailyAppTime     String?
  activeTimeOfDay  String?
  socialMediaUsage String?
  stressLevel      StressLevel?
  preferredContent ContentTypePreference[]

  selfDescriptionWords String[]
  personalityTraits    String[]
  mainMotivation       MotivationType?
  biggestStruggle      BiggestStruggle?


  // 1) "G√ºn√ºn hangi saatlerinde enerjin t√ºkeniyor?" (tek se√ßim)
  energyDipTime EnergyDipTime?

  // 2) "Sana anƒ±nda iyi gelen ≈üey nedir?" (√ßoklu se√ßim)
  comfortZones ComfortZone[]

  // comfortZones i√ßinde PLAY_WITH_PET se√ßilirse sorulur
  petName String?

  // 3) "Kendi kendine en √ßok s√∂ylediƒüin negatif c√ºmle ne?" (tek se√ßim)
  negativeSelfTalk NegativeSelfTalk?

  // 4) "Genellikle nerede √ßalƒ±≈üƒ±yorsun/vakit ge√ßiriyorsun?" (tek se√ßim)
  workContext WorkContext?

  // 5) "Ger√ßek dost acƒ± mƒ± s√∂yler, yoksa tatlƒ± mƒ±?" (tek se√ßim)
  toneOfVoice ToneOfVoice?

  // 6) "Yakla≈üan b√ºy√ºk bir g√ºn var mƒ±?" (tarih + etiket)
  bigDayDate  DateTime?
  bigDayType  BigDayType?
  bigDayLabel String?

  // 7) Ebeveynlik durumu (√ßocuk var mƒ± + opsiyonel ya≈ü aralƒ±ƒüƒ±)
  hasChildren      Boolean?
  childrenAgeRange ChildrenAgeRange?

}

model Feedback {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  rating    Int
  note      String?
  createdAt DateTime @default(now())
}

model Notification {
  id         Int                @id @default(autoincrement())
  title      String
  body       String
  sendAt     DateTime           @default(now())
  status     NotificationStatus @default(PENDING)
  sentAt     DateTime?
  error      String?
  retryCount Int                @default(0)
  createdAt  DateTime           @default(now())

  audiences NotificationAudience[]
  logs      NotificationLog[]

  // New relation
  userNotifications UserNotification[]
}

model Audience {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  rules       Json
  userCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  notifications NotificationAudience[]
  surveys        SurveyAudience[]
}

model NotificationAudience {
  id             Int          @id @default(autoincrement())
  notification   Notification @relation(fields: [notificationId], references: [id])
  notificationId Int

  audience   Audience @relation(fields: [audienceId], references: [id])
  audienceId Int
}

model NotificationLog {
  id             Int          @id @default(autoincrement())
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  notificationId Int

  attempt      Int
  statusBefore NotificationStatus?
  statusAfter  NotificationStatus?
  success      Boolean
  error        String?
  provider     String?
  providerId   String?
  createdAt    DateTime @default(now())
}

model UserNotification {
  id             Int @id @default(autoincrement())
  userId         Int
  notificationId Int

  deliveredAt DateTime  @default(now())
  shownAt     DateTime?
  openedAt    DateTime?

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  feedback NotificationFeedback?

  @@unique([userId, notificationId])
  @@index([userId, deliveredAt])
  @@index([notificationId])
}

model NotificationFeedback {
  id                 Int @id @default(autoincrement())
  userId             Int
  userNotificationId Int @unique

  rating    Int
  note      String?
  createdAt DateTime @default(now())

  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userNotification UserNotification @relation(fields: [userNotificationId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model Survey {
  id          Int          @id @default(autoincrement())
  title       String
  description String?
  status      SurveyStatus @default(DRAFT)

  // yayƒ±n penceresi (opsiyonel)
  startAt DateTime?
  endAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // relations
  questions SurveyQuestion[]
  audiences SurveyAudience[]
  responses SurveyResponse[]

  @@index([status, startAt, endAt])
}

model SurveyQuestion {
  id       Int   @id @default(autoincrement())
  surveyId Int
  survey   Survey @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  order Int @default(0)
  text  String

  options SurveyOption[]
  answers SurveyAnswer[]

  @@index([surveyId, order])
}


model SurveyOption {
  id         Int @id @default(autoincrement())
  questionId Int
  question   SurveyQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  order Int @default(0)
  text  String

  answers SurveyAnswer[]

  @@index([questionId, order])
}

model SurveyAudience {
  id         Int @id @default(autoincrement())
  surveyId   Int
  audienceId Int

  survey   Survey   @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  audience Audience @relation(fields: [audienceId], references: [id], onDelete: Cascade)

  @@unique([surveyId, audienceId])
  @@index([audienceId])
}

model SurveyResponse {
  id       Int @id @default(autoincrement())
  userId   Int
  surveyId Int

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  survey Survey @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  answers SurveyAnswer[]

  // aynƒ± kullanƒ±cƒ± aynƒ± ankete 1 kez cevap versin
  @@unique([userId, surveyId])
  @@index([surveyId, createdAt])
}

model SurveyAnswer {
  id         Int @id @default(autoincrement())
  responseId Int
  questionId Int
  optionId   Int

  response SurveyResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)
  question SurveyQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  option   SurveyOption   @relation(fields: [optionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  // bir response i√ßinde aynƒ± soruya 1 cevap
  @@unique([responseId, questionId])
  @@index([questionId, optionId])
}
